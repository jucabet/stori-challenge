version: '3.7'
services:
  localstack:
    container_name: "${LOCALSTACK_DOCKER_NAME-localstack_main}"
    image: localstack/localstack
    ports:
      - "127.0.0.1:4566:4566"            # LocalStack Gateway
      - "127.0.0.1:4510-4559:4510-4559"  # external services port range
      - "127.0.0.1:53:53"                # DNS config (only required for Pro)
      - "127.0.0.1:53:53/udp"            # DNS config (only required for Pro)
      - "127.0.0.1:443:443"              # LocalStack HTTPS Gateway (only required for Pro)
    environment:
      - SERVICES=serverless,s3,cloudformation
      - CONFIG_DIR=~/.localstack
      - DEBUG=${DEBUG-}
      - PERSISTENCE=${PERSISTENCE-}
      - LAMBDA_EXECUTOR=${LAMBDA_EXECUTOR-}
      - LOCALSTACK_API_KEY=${LOCALSTACK_API_KEY-}  # only required for Pro
      - DOCKER_HOST=unix:///var/run/docker.sock
    volumes:
      - "${LOCALSTACK_VOLUME_DIR:-./volume}:/var/lib/localstack"
      - "/var/run/docker.sock:/var/run/docker.sock"
  process-transactions:
    build: ../../src/process-transactions
    container_name: process-transactions
    network_mode: "host"
    environment:
      ENV: docker
      AWS_REGION: us-east-1
      AWS_DYNAMO_TABLE_NAME: stori-transactions-db
      URL_ENDPOINT_LOCALSTACK: http://localhost:4566
      AWS_BUCKET_NAME: transactions-bucket
      AWS_SQS_NAME: reports-queue
      AWS_ACCESS_KEY_ID: "xyz123"
      AWS_SECRET_ACCESS_KEY: "qL4lyH"
    depends_on:
      - localstack
  send-reports:
    build: ../../src/send-reports
    container_name: send-reports
    network_mode: "host"
    environment:
      ENV: docker
      MAILER_FROM_HOST: 'smtp.gmail.com'
      MAILER_FROM_PORT: 587
      MAILER_FROM_EMAIL: 'jucabet15@gmail.com'
      MAILER_FROM_USER: 'jucabet15@gmail.com'
      MAILER_FROM_PASSWORD: 'laPass15*'
      AWS_REGION: 'us-east-1'
      AWS_DYNAMO_TABLE_NAME: 'stori-transactions-db'
      URL_ENDPOINT_LOCALSTACK: 'http://localhost:4566'
      AWS_SQS_NAME: 'reports-queue'
      AWS_ACCESS_KEY_ID: "xyz123"
      AWS_SECRET_ACCESS_KEY: "qL4lyH"
    depends_on:
      - localstack
